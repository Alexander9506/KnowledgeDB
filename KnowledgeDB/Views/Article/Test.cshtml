<div id="file-explorer" class="container">
    <div class="form-group row">
        <input id="file-explorer-search" class="form-control col-md-7" type="search" name="search" placeholder="Search" aria-label="Search" autocomplete="off"/>
        <button type="button" class="btn btn-outline-success col-md-2 ml-1">Search</button>
        <input id="file-explorer-add-button" multiple type="file" class="d-none" />
        
        <button type="button" class="btn btn-outline-secondary col-md-2 ml-1" onclick="document.getElementById('file-explorer-add-button').click()">Add File</button>

        
    </div>

    <div id="file-explorer-settings" class="row">
        <span class="text-black-50 col">Settings</span>
        <div class="custom-control custom-switch col">
            <input type="checkbox" class="custom-control-input" id="file-explorer-cbox-only-new-files">
            <label class="custom-control-label" for="file-explorer-cbox-only-new-files">Only new uploaded Files</label>
        </div>
        <div class="custom-control custom-switch col">
            <input type="checkbox" class="custom-control-input" id="file-explorer-cbox-preview-images">
            <label class="custom-control-label" for="file-explorer-cbox-preview-images">Show preview images</label>
        </div>
    </div>

    <div>
        <div id="file-explorer-header" class="rowjustify-content-end">
            <span>File Actions</span> <button image="Upload" type="button" button-classes="btn btn-outline-info" image-classes="fa-1x">Upload all files</button>
        </div>
        <table class="table" id="file-explorer-file-table">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody id="file-explorer-file-table-body">
                <tr>
                    <td>FileOne</td>
                    <td>
                        <button image="Upload" type="button" image-classes="fa-1x">Upload</button>
                        <button image="Copy" type="button" image-classes="fa-1x">Copy File URL</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    @*<form id="form" method="post" enctype="multipart/form-data" asp-action="UploadFiles" asp-controller="Article">
        <input id="file" multiple type="file" name="file" />
        <input type="button" value="Upload" onclick="UplodeFiles('file', '@Url.Action("Test", "Article")')">
    </form>*@
</div>

<script>

    //TODO: Anders machen
    let uploadAction = "@Url.Action("UploadFiles", "Article")";


    //TODO: sollte ein eigenes js-file bekommen
    let listOfUnUploadedFiles = [];
    let listOfFiles = [];
    let fileButton = document.getElementById('file-explorer-add-button');

    fileButton.onchange = function () {
        let newFiles = [];

        newFiles.push.apply(newFiles, this.files);

        for (let i = 0; i < newFiles.length; i++) {
            let file = newFiles[i];
            file.id = file.name;
        }
        //add new Files to upload list
        listOfUnUploadedFiles.push(newFiles);
        //add new Files to Table
        AddFilesToTable(newFiles);
    }

    function AddFilesToTable(fileList) {
        //TODO: Hier weitermachen buttons brauchen noch listener und die images vom server müssen geladen werden können
        let tableBody = document.getElementById('file-explorer-file-table-body');

        for (let i = 0; i < fileList.length; i++) {
            let newRow = document.createElement('tr');
            let colName = document.createElement('td');
            let colActions = document.createElement('td');

            let currentFile = fileList[i]; 

            newRow.id = "file-explorer-file-row-id-" + listOfFiles.length;
            newRow.dataset.fileId = currentFile.id;

            listOfFiles.push(currentFile);

            colName.textContent = currentFile.name;

            let buttonUpload = createImageButton("fas fa-upload", "btn btn-outline-info m-1", "Upload")
            buttonUpload.onclick = function () {
                let fileId = this.parentElement.parentElement.dataset.fileId;
                const self = this;
                
                if (fileId) {
                    const newImage = replaceButtonWithImage(self, "fa fa-spinner fa-spin")

                    UploadFiles([getFileById(fileId)], uploadAction, function (success) {
                        console.log("Ready");
                        ChangeImage(newImage, "fa fa-check m-1");
                    });
                }
            }

            let buttonRemove = createImageButton("fas fa-trash", "btn btn-outline-danger m-1", "Remove")
            
            colActions.appendChild(buttonUpload);
            colActions.appendChild(buttonRemove);

            newRow.appendChild(colName);
            newRow.appendChild(colActions);

            
            tableBody.appendChild(newRow);
        }
    }

    function replaceButtonWithImage(button, imageClasses) {
        const buttonParent = button.parentElement;
        if (buttonParent != null) {
            const image = document.createElement('i')
            image.className = imageClasses

            buttonParent.insertBefore(image, button);
            buttonParent.removeChild(button);

            return image;
        }
    }

    function getFileById(fileId) {
        for (let i = 0; i < listOfFiles.length; i++) {
            let file = listOfFiles[i];
            if (file.id === fileId) {
                return file;
            }
        }
    }

    function ChangeImage(image, imageClasses) {
        if (image != null) {
            image.className = imageClasses;
        }
    }

    function createImageButton(imageClasses, buttonClasses, buttonTitle) {
        let button = document.createElement('button');
        let image = document.createElement('i');

        image.className = imageClasses;
        button.title = buttonTitle;
        button.className = buttonClasses
        button.appendChild(image);

        return button;
    }
</script>

